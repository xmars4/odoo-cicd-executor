name: ci/cd
on:
    workflow_call:
        inputs:
            repo_name:
                required: true
                type: string
            action:
                required: true
                type: string
            source_branch:
                required: true
                type: string
            target_branch:
                required: true
                type: string
            commit_sha:
                required: false
                type: string

env:
    # Common variables
    REPO_PATH: ${{ github.workspace }}
    ODOO_CUSTOM_ADDONS_PATH: ${{ github.workspace }}
    ODOO_CONFIG_FILE: ${{ github.workspace }}/.github/odoo/etc/odoo.conf
    ODOO_DOCKER_COMPOSE_PATH: ${{ github.workspace }}/.github/odoo
    ODOO_DOCKER_COMPOSE_FILE: ${{ github.workspace }}/.github/odoo/docker-compose.yml
    ODOO_TEST_DATABASE_NAME: odoo_test
    ODOO_LOG_FILE_CONTAINER: /var/log/odoo/odoo.log
    ODOO_LOG_FILE_HOST: ${{ github.workspace }}/.github/odoo/logs/odoo.log
    CICD_ODOO_OPTIONS: ${{ github.workspace }}/.github/conf/odoo.json
    CICD_SCRIPTS_PATH: ${{ github.workspace }}/.github/scripts
    CICD_UTILS_SCRIPTS_PATH: ${{ github.workspace }}/.github/scripts/utils.sh
    SERVER_CICD_SCRIPT_FOLDER: /tmp/odoo/cicd/${{ github.repository_id }}

    # ==== Workflow inputs ====
    SOURCE_BRANCH: ${{ inputs.source_branch }}
    TARGET_BRANCH: ${{ inputs.target_branch }}
    REPOSITORY: ${{ inputs.repo_name }}

    # ==== Repository secrets ====
    SSH_KEY_GITHUB: ${{secrets.SSH_KEY_GITHUB}}
    PAT_GITHUB: ${{ secrets.PAT_GITHUB }}
    DOCKERHUB_USERNAME: ${{secrets.DOCKERHUB_USERNAME}}
    DOCKERHUB_TOKEN: ${{secrets.DOCKERHUB_TOKEN}}

    # ==== Environment secrets =====
    TELEGRAM_CHANNEL_ID: ${{secrets.TELEGRAM_CHANNEL_ID}}
    TELEGRAM_TOKEN: ${{secrets.TELEGRAM_TOKEN}}
    SERVER_PRIVATE_KEY: ${{secrets.SERVER_PRIVATE_KEY}}
    SERVER_DB_PASSWORD: ${{secrets.SERVER_DB_PASSWORD}}

    # ===== Environment variables =====
    ODOO_IMAGE_TAG: ${{ vars.ODOO_IMAGE_TAG }}
    DB_IMAGE_TAG: ${{ vars.DB_IMAGE_TAG }}
    SERVER_HOST: ${{ vars.SERVER_HOST }}
    SERVER_USER: ${{ vars.SERVER_USER }}
    SERVER_SSH_PORT: ${{ vars.SERVER_SSH_PORT }}
    SERVER_DEPLOY_PATH: ${{ vars.SERVER_DEPLOY_PATH }}
    SERVER_ODOO_URL: ${{ vars.SERVER_ODOO_URL }}
    SERVER_ODOO_DB_NAME: ${{ vars.SERVER_ODOO_DB_NAME }}

jobs:
    pylint-test:
        runs-on: ubuntu-latest
        env:
            commit_context: CI/CD - Pylint Test
        environment: ${{inputs.repo_name}}
        if: inputs.action == 'test' || inputs.action == 'deploy'
        steps:
            - name: Set commit status as pending
              uses: myrotvorets/set-commit-status-action@master
              with:
                  repo: ${{ inputs.repo_name }}
                  sha: ${{ inputs.commit_sha }}
                  token: ${{ secrets.PAT_GITHUB }}
                  status: pending
                  context: ${{ env.commit_context }}

            - name: Checkout private repo
              uses: actions/checkout@v4
              with:
                  repository: ${{ env.REPOSITORY }}
                  ssh-key: ${{ env.SSH_KEY_GITHUB }}
                  path: ${{ env.REPO_PATH }}
                  ref: ${{ inputs.action == 'test' && env.SOURCE_BRANCH || env.TARGET_BRANCH }}
                  fetch-depth: 1

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Prepare data
              run: |
                  bash $CICD_SCRIPTS_PATH/precheck-workflow.sh
                  bash $CICD_SCRIPTS_PATH/prepare-pylint-test.sh
            - uses: isbang/compose-action@v1.5.1
              with:
                  compose-file: ${{ env.ODOO_DOCKER_COMPOSE_FILE }}
                  up-flags: "--quiet-pull"
                  down-flags: "--volumes"

            - name: Run Pylint Test cases
              id: run_pylint_test
              run: |
                  bash $CICD_SCRIPTS_PATH/run-pylint-test.sh

            - name: Set final commit status
              if: ${{always()}}
              uses: myrotvorets/set-commit-status-action@master
              with:
                  repo: ${{ inputs.repo_name }}
                  sha: ${{ inputs.commit_sha }}
                  token: ${{ secrets.PAT_GITHUB }}
                  status: ${{ steps.run_pylint_test.conclusion == 'success' && 'success' || 'failure' }}
                  context: ${{ env.commit_context }}

    unit-test-at-install:
        runs-on: ubuntu-latest
        env:
            commit_context: CI/CD - Unit Test At Install
        environment: ${{inputs.repo_name}}
        if: inputs.action == 'test' || inputs.action == 'deploy'
        steps:
            - name: Set commit status as pending
              uses: myrotvorets/set-commit-status-action@master
              with:
                  repo: ${{ inputs.repo_name }}
                  sha: ${{ inputs.commit_sha }}
                  token: ${{ secrets.PAT_GITHUB }}
                  status: pending
                  context: ${{ env.commit_context }}
            - name: Checkout private repo
              uses: actions/checkout@v4
              with:
                  repository: ${{ env.REPOSITORY }}
                  ssh-key: ${{ env.SSH_KEY_GITHUB }}
                  path: ${{ env.REPO_PATH }}
                  ref: ${{ inputs.action == 'test' && env.SOURCE_BRANCH || env.TARGET_BRANCH }}
                  fetch-depth: 1

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Prepare data
              run: |
                  bash $CICD_SCRIPTS_PATH/prepare-unit-test.sh "at_install"
            - uses: isbang/compose-action@v1.5.1
              with:
                  compose-file: ${{ env.ODOO_DOCKER_COMPOSE_FILE }}
                  up-flags: "--quiet-pull"
                  down-flags: "--volumes"

            - name: Run Unit test cases
              id: run_post_install_unit_test
              run: |
                  bash $CICD_SCRIPTS_PATH/run-unit-test.sh "At Install"

            - name: Set final commit status
              if: ${{always()}}
              uses: myrotvorets/set-commit-status-action@master
              with:
                  repo: ${{ inputs.repo_name }}
                  sha: ${{ inputs.commit_sha }}
                  token: ${{ secrets.PAT_GITHUB }}
                  status: ${{ steps.run_post_install_unit_test.conclusion == 'success' && 'success' || 'failure' }}
                  context: ${{ env.commit_context }}

    unit-test-post-install:
        runs-on: ubuntu-latest
        env:
            commit_context: CI/CD - Unit Test Post Install
        environment: ${{inputs.repo_name}}
        if: inputs.action == 'test' || inputs.action == 'deploy'
        steps:
            - name: Set commit status as pending
              uses: myrotvorets/set-commit-status-action@master
              with:
                  repo: ${{ inputs.repo_name }}
                  sha: ${{ inputs.commit_sha }}
                  token: ${{ secrets.PAT_GITHUB }}
                  status: pending
                  context: ${{ env.commit_context }}
            - name: Checkout private repo
              uses: actions/checkout@v4
              with:
                  repository: ${{ env.REPOSITORY }}
                  ssh-key: ${{ env.SSH_KEY_GITHUB }}
                  path: ${{ env.REPO_PATH }}
                  ref: ${{ inputs.action == 'test' && env.SOURCE_BRANCH || env.TARGET_BRANCH }}
                  fetch-depth: 1

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Prepare data
              run: |
                  bash $CICD_SCRIPTS_PATH/prepare-unit-test.sh "post_install"
            - uses: isbang/compose-action@v1.5.1
              with:
                  compose-file: ${{ env.ODOO_DOCKER_COMPOSE_FILE }}
                  up-flags: "--quiet-pull"
                  down-flags: "--volumes"

            - name: Run Unit test cases
              id: run_post_install_unit_test
              run: |
                  bash $CICD_SCRIPTS_PATH/run-unit-test.sh "Post Install"

            - name: Set final commit status
              if: ${{always()}}
              uses: myrotvorets/set-commit-status-action@master
              with:
                  repo: ${{ inputs.repo_name }}
                  sha: ${{ inputs.commit_sha }}
                  token: ${{ secrets.PAT_GITHUB }}
                  status: ${{ steps.run_post_install_unit_test.conclusion == 'success' && 'success' || 'failure' }}
                  context: ${{ env.commit_context }}

    integration-test:
        runs-on: ubuntu-latest
        if: inputs.action == 'deploy'
        environment: ${{inputs.repo_name}}
        needs: [pylint-test, unit-test-at-install, unit-test-post-install]
        env:
            LOCAL_BACKUP_FILE_PATH: ${{github.workspace}}/odoo.tar.gz
            SERVER_BACKUP_FOLDER: /tmp/odoo/backup/${{github.repository_id}}
            SERVER_LATEST_BACKUP_FILE_PATH: /tmp/odoo/backup/${{github.repository_id}}/.odoo.tar.gz
            GITHUB_RUN_ATTEMPT: ${{github.run_attempt}}
            commit_context: CI/CD - Integration Test

        steps:
            - name: Set commit status as pending
              uses: myrotvorets/set-commit-status-action@master
              with:
                  repo: ${{ inputs.repo_name }}
                  sha: ${{ inputs.commit_sha }}
                  token: ${{ secrets.PAT_GITHUB }}
                  status: pending
                  context: ${{ env.commit_context }}

            - name: Checkout private repo
              uses: actions/checkout@v4
              with:
                  repository: ${{ env.REPOSITORY }}
                  ssh-key: ${{ env.SSH_KEY_GITHUB }}
                  path: ${{ env.REPO_PATH }}
                  ref: ${{ env.TARGET_BRANCH }}
                  fetch-depth: 1

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: "Upload backup script file to server"
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ env.SERVER_HOST }}
                  username: ${{ env.SERVER_USER }}
                  key: ${{ secrets.SERVER_PRIVATE_KEY }}
                  password: ${{ secrets.PASSWORD }}
                  port: ${{ secrets.PORT }}
                  source: ${{ env.CICD_SCRIPTS_PATH }}/server-backup.sh
                  target: ${{ env.SERVER_CICD_SCRIPT_FOLDER }}
                  strip_components: 4

            - name: "Backup Odoo on server"
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ env.SERVER_HOST }}
                  username: ${{ env.SERVER_USER }}
                  key: ${{ secrets.SERVER_PRIVATE_KEY }}
                  port: ${{ env.SERVER_SSH_PORT }}
                  command_timeout: 30m
                  script: |
                      bash ${{ env.SERVER_CICD_SCRIPT_FOLDER }}/server-backup.sh "${{env.SERVER_DEPLOY_PATH}}" "${{env.SERVER_ODOO_DB_NAME}}" "${{secrets.SERVER_DB_PASSWORD}}" "${{env.ODOO_IMAGE_TAG}}" ${{ env.GITHUB_RUN_ATTEMPT }} "${{ env.SERVER_BACKUP_FOLDER }}"

            - name: "Download backup file"
              uses: nicklasfrahm/scp-action@main
              with:
                  direction: download
                  host: ${{ env.SERVER_HOST }}
                  username: ${{ env.SERVER_USER }}
                  key: ${{ secrets.SERVER_PRIVATE_KEY }}
                  insecure_ignore_fingerprint: true
                  action_timeout: 30m
                  source: ${{env.SERVER_LATEST_BACKUP_FILE_PATH}}
                  target: ${{env.LOCAL_BACKUP_FILE_PATH}}

            - name: "Prepare data"
              run: |
                  bash $CICD_SCRIPTS_PATH/prepare-integration-test.sh
            - uses: isbang/compose-action@v1.5.1
              with:
                  compose-file: ${{ env.ODOO_DOCKER_COMPOSE_FILE }}
                  up-flags: "--quiet-pull"
                  down-flags: "--volumes"

            - name: "Integration test"
              id: run_integration_test
              run: |
                  bash $CICD_SCRIPTS_PATH/run-integration-test.sh ${{env.LOCAL_BACKUP_FILE_PATH}}

            - name: Set final commit status
              if: ${{always()}}
              uses: myrotvorets/set-commit-status-action@master
              with:
                  repo: ${{ inputs.repo_name }}
                  sha: ${{ inputs.commit_sha }}
                  token: ${{ secrets.PAT_GITHUB }}
                  status: ${{ steps.run_integration_test.conclusion == 'success' && 'success' || 'failure' }}
                  context: ${{ env.commit_context }}

    deploy-server:
        runs-on: ubuntu-latest
        environment: ${{inputs.repo_name}}
        needs: [integration-test]
        env:
            SERVER_DEPLOY_SCRIPT_PATH: /tmp/odoo/cicd/${{ github.repository_id }}/deploy.sh
            commit_context: CI/CD - Deploy to Server
        steps:
            - name: Set commit status as pending
              uses: myrotvorets/set-commit-status-action@master
              with:
                  repo: ${{ inputs.repo_name }}
                  sha: ${{ inputs.commit_sha }}
                  token: ${{ secrets.PAT_GITHUB }}
                  status: pending
                  context: ${{ env.commit_context }}

            - name: Checkout private repo
              uses: actions/checkout@v4
              with:
                  repository: ${{ env.REPOSITORY }}
                  ssh-key: ${{ env.SSH_KEY_GITHUB }}
                  path: ${{ env.REPO_PATH }}
                  ref: ${{ env.TARGET_BRANCH }}
                  fetch-depth: 1

            - name: "Upload deploy script file to server"
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ env.SERVER_HOST }}
                  username: ${{ env.SERVER_USER }}
                  key: ${{ secrets.SERVER_PRIVATE_KEY }}
                  password: ${{ secrets.PASSWORD }}
                  port: ${{ secrets.PORT }}
                  source: ${{ env.CICD_SCRIPTS_PATH }}/server-deploy.sh
                  target: ${{ env.SERVER_CICD_SCRIPT_FOLDER }}
                  strip_components: 4

            - name: "Deploy to server"
              id: deploy_to_server
              uses: appleboy/ssh-action@v1.0.0
              env:
                  SERVER_CUSTOM_ADDONS_PATH: ${{env.SERVER_DEPLOY_PATH}}/..
                  SERVER_CONFIG_FILE: ${{env.SERVER_DEPLOY_PATH}}/etc/odoo.conf
                  SERVER_DOCKER_COMPOSE_PATH: ${{env.SERVER_DEPLOY_PATH}}
                  GITHUB_STEP_SUMMARY: ${{ env.GITHUB_STEP_SUMMARY }}
              with:
                  host: ${{ env.SERVER_HOST }}
                  username: ${{ env.SERVER_USER }}
                  key: ${{ secrets.SERVER_PRIVATE_KEY }}
                  port: ${{ env.SERVER_SSH_PORT }}
                  script: |
                      bash ${{ env.SERVER_CICD_SCRIPT_FOLDER }}/server-deploy.sh "${{env.SERVER_DOCKER_COMPOSE_PATH}}" "${{env.SERVER_CUSTOM_ADDONS_PATH}}" "${{env.SERVER_CONFIG_FILE}}" "dump_private_key" "${{ env.SERVER_ODOO_URL }}" "${{ env.SERVER_ODOO_DB_NAME }}"

            - name: The Deploy step has failed
              if: ${{ failure() }}
              run: |
                  bash ${{env.CICD_SCRIPTS_PATH}}/post-server-deploy.sh "failed"

            - name: The Deploy step has successful
              if: ${{ success() }}
              run: |
                  bash ${{env.CICD_SCRIPTS_PATH}}/post-server-deploy.sh "success"

            - name: Set final commit status
              if: ${{always()}}
              uses: myrotvorets/set-commit-status-action@master
              with:
                  repo: ${{ inputs.repo_name }}
                  sha: ${{ inputs.commit_sha }}
                  token: ${{ secrets.PAT_GITHUB }}
                  status: ${{ steps.deploy_to_server.conclusion == 'success' && 'success' || 'failure' }}
                  context: ${{ env.commit_context }}
